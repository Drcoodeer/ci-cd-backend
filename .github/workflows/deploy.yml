name: Build and Deploy with Self-Hosted Runner

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build TypeScript
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            package*.json
            Dockerfile
            docker-compose.yml
            .dockerignore
            version.txt
          retention-days: 1

  deploy:
    needs: build
    runs-on: self-hosted
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: /tmp/build-artifacts
      
      - name: Copy files to deployment directory
        run: |
          echo "ğŸ“¦ Copying files to /home/dixit/ci-cd-backend..."
          mkdir -p /home/dixit/ci-cd-backend
          
          # Copy all files from artifacts
          cp -r /tmp/build-artifacts/* /home/dixit/ci-cd-backend/
          
          # Cleanup temp artifacts
          rm -rf /tmp/build-artifacts
          
          echo "âœ… Files copied successfully"
      
      - name: Verify .env file exists
        run: |
          if [ ! -f /home/dixit/ci-cd-backend/.env ]; then
            echo "âŒ ERROR: .env file not found on server!"
            exit 1
          else
            echo "âœ… .env file found on server"
          fi
      
      - name: Build Docker image
        working-directory: /home/dixit/ci-cd-backend
        run: |
          echo "ğŸ³ Building Docker image..."
          docker compose build
          echo "âœ… Docker image built successfully"
      
      - name: Stop and remove old container
        working-directory: /home/dixit/ci-cd-backend
        run: |
          echo "ğŸ›‘ Stopping old container..."
          docker compose down || true
          echo "âœ… Old container stopped"
      
      - name: Start new container
        working-directory: /home/dixit/ci-cd-backend
        run: |
          echo "ğŸš€ Starting new container..."
          docker compose up -d
          echo "âœ… Container started successfully"
      
      - name: Check container health
        working-directory: /home/dixit/ci-cd-backend
        run: |
          echo "ğŸ” Waiting for container to be healthy..."
          sleep 5
          
          if docker compose ps | grep -q "Up"; then
            echo "âœ… Container is running"
            docker compose ps
          else
            echo "âŒ Container failed to start"
            docker compose logs
            exit 1
          fi
      
      - name: Cleanup old images
        run: |
          echo "ğŸ§¹ Cleaning up old Docker images..."
          docker image prune -f
          echo "âœ… Cleanup complete"
      
      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Deployment path: /home/dixit/ci-cd-backend"
          echo "ğŸ³ Container name: ci-cd-backend"
          echo "ğŸŒ Health check: http://localhost:3000/health"
          echo "ğŸ—ï¸  Built on: GitHub VM"
          echo "ğŸš€ Deployed on: Self-hosted runner"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

